name: PR Tests

on:
  pull_request:
    branches: [ main ]

env:
  OCTOML_EMPLOYEE: 1
  OCTOML_TELEMETRY: false
  OCTOML: /home/runner/work/octoml-cli-tutorials/octoml-cli-tutorials/target/debug/octoml


jobs:
  lint:
    name: shellcheck
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Run Shellcheck
      uses: ludeeus/action-shellcheck@1.1.0
  runtest:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Make parent dirs for octoml-bin
      run: mkdir -p target/debug
    - name: Download octoml-bin (tar.gz)
      run: curl --fail ${{secrets.CLI_DOWNLOAD_LINK_UBUNTU}} --output octoml.tar.gz && tar xzf octoml.tar.gz && mv octoml target/debug/octoml
    - name: Show Download
      run: ls -lR target/debug/octoml
    - name: chmod octoml bin
      run: chmod 775 target/debug/octoml
    - name: print octoml version
      run: $OCTOML -V
    - uses: actions/setup-python@v2
      with:
        python-version: 3.8
    - name: Install poetry
      uses: abatilo/actions-poetry@v2.0.0
      with:
        poetry-version: 1.1.13
    - name: Run setup.sh
      run: cd tutorials && ./setup.sh
    - name: Run setup-cloud.sh
      run: cd tutorials && ./setup-cloud.sh
    - name: build vision model
      run: cd tutorials/vision && $OCTOML deploy
    - name: docker check running
      run: sleep 4  && ps -ef | grep 8000
    - name: execute vision model with native grpc
      run: cd tutorials/vision && python run.py --triton
    - name: execute vision model with python grpc
      run: cd tutorials/vision && PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION=python python run.py --triton
    - name: execute vision model with http
      run: cd tutorials/vision && python run.py --triton --protocol=http
